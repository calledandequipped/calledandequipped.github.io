<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Called & Equipped!</title>
    <style>
        :root {
            --primary-gold: #D4AF37;
            --deep-blue: #1B3A57;
            --cream: #FBF7F0;
            --charcoal: #2C2C2C;
            --sage: #7C8471;
            --light-gold: #F4E5C2;
            --white: #FFFFFF;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: var(--charcoal);
            background: linear-gradient(135deg, var(--deep-blue) 0%, var(--charcoal) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .success-container {
            background: var(--white);
            max-width: 600px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-header {
            background: var(--primary-gold);
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 3rem;
            color: var(--primary-gold);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .success-header h1 {
            color: var(--deep-blue);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .success-header p {
            color: var(--deep-blue);
            opacity: 0.9;
        }

        .success-body {
            padding: 2.5rem;
        }

        .loading-message {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--cream);
            border-top: 3px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-gold);
        }

        .info-box h3 {
            color: var(--deep-blue);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .info-box p {
            color: var(--sage);
            line-height: 1.6;
        }

        .action-button {
            display: inline-block;
            width: 100%;
            padding: 1rem;
            background: var(--deep-blue);
            color: var(--white);
            text-decoration: none;
            text-align: center;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            margin-top: 1rem;
            border: none;
            cursor: pointer;
        }

        .action-button:hover {
            background: var(--primary-gold);
            color: var(--deep-blue);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .action-button:disabled {
            background: var(--sage);
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        .action-button.secondary {
            background: transparent;
            border: 2px solid var(--deep-blue);
            color: var(--deep-blue);
        }

        .action-button.secondary:hover {
            background: var(--deep-blue);
            color: var(--white);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #ef5350;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #66bb6a;
        }

        .checklist {
            list-style: none;
            margin: 1rem 0;
        }

        .checklist li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .checklist li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: var(--primary-gold);
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .button-group .action-button {
            flex: 1;
        }

        /* Debug info box */
        .debug-info {
            background: #f5f5f5;
            border: 1px dashed #999;
            padding: 1rem;
            margin-top: 2rem;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85rem;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .debug-info h4 {
            margin-bottom: 0.5rem;
            color: #666;
        }

        .debug-info p {
            margin: 0.25rem 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-header">
            <div class="success-icon">âœ¨</div>
            <h1>Welcome to Called & Equipped!</h1>
            <p>Your journey to discovering your divine purpose begins now</p>
        </div>
        
        <div class="success-body">
            <!-- Loading State -->
            <div id="loadingState" class="loading-message">
                <div class="loading-spinner"></div>
                <p>Setting up your account...</p>
                <p style="font-size: 0.9rem; color: var(--sage); margin-top: 1rem;">This may take a few moments</p>
            </div>

            <!-- Success State -->
            <div id="successState" style="display: none;">
                <div class="success-message">
                    <strong>Success!</strong> Your enrollment is complete and your account has been created.
                </div>

                <div class="info-box">
                    <h3>ðŸ“§ Check Your Email</h3>
                    <p>We've sent you a welcome email with your personal access link to the student portal. Please check your inbox (and spam folder) for an email from Called & Equipped.</p>
                </div>

                <div class="info-box">
                    <h3>ðŸŽ“ What's Next?</h3>
                    <ul class="checklist">
                        <li>Access the student portal using the button below</li>
                        <li>Start with Week 1: Created for a Purpose</li>
                        <li>Download your workbooks and materials</li>
                        <li>Join our Facebook community for support</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button id="accessPortalBtn" class="action-button" onclick="accessPortal()">
                        Access Student Portal â†’
                    </button>
                </div>

                <p style="text-align: center; margin-top: 1.5rem; color: var(--sage); font-size: 0.9rem;">
                    <strong>Important:</strong> Bookmark the portal page for easy access<br>
                    Having trouble? Contact us at support@calledandequipped.com
                </p>
            </div>

            <!-- Error State -->
            <div id="errorState" style="display: none;">
                <div class="error-message">
                    <strong>Attention Needed</strong><br>
                    <span id="errorMessage">We're having trouble verifying your payment. This is usually temporary.</span>
                </div>
                
                <div class="info-box">
                    <h3>Don't worry! Here's what to do:</h3>
                    <p><strong>1.</strong> Check your email - your access link may already be there</p>
                    <p><strong>2.</strong> Save your Stripe receipt for reference</p>
                    <p><strong>3.</strong> If you don't receive an email within 10 minutes, click the button below</p>
                </div>

                <div class="button-group">
                    <button class="action-button secondary" onclick="retryVerification()">
                        Try Again
                    </button>
                    <a href="mailto:support@calledandequipped.com?subject=Help with Portal Access" class="action-button">
                        Contact Support
                    </a>
                </div>

                <p style="text-align: center; margin-top: 1.5rem; color: var(--sage); font-size: 0.9rem;">
                    Support Email: support@calledandequipped.com<br>
                    Please include your email address used during checkout
                </p>
            </div>

            <!-- Debug Info (hidden by default) -->
            <div id="debugInfo" class="debug-info">
                <h4>Debug Information:</h4>
                <p id="debugSession">Session ID: </p>
                <p id="debugToken">Token: </p>
                <p id="debugStatus">Status: </p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sessionId = null;
        let accessToken = null;
        let verificationAttempts = 0;
        const maxAttempts = 3;

        // Process the success page
        async function processSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session_id');
            
            // Update debug info
            document.getElementById('debugSession').textContent = `Session ID: ${sessionId || 'Not found'}`;
            
            // Show debug info if debug=true is in URL
            if (urlParams.get('debug') === 'true') {
                document.getElementById('debugInfo').classList.add('show');
            }
            
            if (!sessionId) {
                showError('No payment session found. Please check your email for your access link, or contact support if you need assistance.');
                return;
            }

            await verifyPayment();
        }

        async function verifyPayment() {
            verificationAttempts++;
            document.getElementById('debugStatus').textContent = `Status: Verifying payment (Attempt ${verificationAttempts})`;

            try {
                const response = await fetch('https://called-equipped-backend.onrender.com/api/verify-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Payment verification failed');
                }
                
                // Store the access token
                if (data.accessToken && data.accessToken !== 'undefined') {
                    accessToken = data.accessToken;
                    localStorage.setItem('accessToken', data.accessToken);
                    document.getElementById('debugToken').textContent = `Token: ${data.accessToken.substring(0, 10)}...`;
                    document.getElementById('debugStatus').textContent = `Status: Success! Token received`;
                    
                    // Show success state
                    showSuccess();
                } else {
                    throw new Error('No access token received from server');
                }
                
            } catch (error) {
                console.error('Error processing payment:', error);
                document.getElementById('debugStatus').textContent = `Status: Error - ${error.message}`;
                
                if (verificationAttempts < maxAttempts) {
                    // Retry after a delay
                    setTimeout(() => {
                        verifyPayment();
                    }, 3000);
                } else {
                    showError(`Verification failed after ${maxAttempts} attempts. ${error.message}`);
                }
            }
        }

        function showSuccess() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
            
            // Enable the portal button if we have a token
            const portalBtn = document.getElementById('accessPortalBtn');
            if (accessToken && accessToken !== 'undefined') {
                portalBtn.disabled = false;
                portalBtn.textContent = 'Access Student Portal â†’';
            } else {
                portalBtn.disabled = true;
                portalBtn.textContent = 'Check Email for Access Link';
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function accessPortal() {
            // Try to get token from localStorage if not in memory
            if (!accessToken || accessToken === 'undefined') {
                accessToken = localStorage.getItem('accessToken');
            }
            
            if (accessToken && accessToken !== 'undefined' && accessToken !== 'null') {
                // Redirect to portal with token
                window.location.href = `/portal.html?token=${accessToken}`;
            } else {
                alert('Your access link has been sent to your email. Please check your inbox (and spam folder) to access the student portal.\n\nIf you don\'t receive it within 10 minutes, please contact support at support@calledandequipped.com');
            }
        }

        function retryVerification() {
            // Reset attempts and try again
            verificationAttempts = 0;
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            verifyPayment();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Success page loaded');
            processSuccess();
        });

        // Add keyboard shortcut for debug mode (Ctrl+Shift+D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                document.getElementById('debugInfo').classList.toggle('show');
            }
        });
    </script>
</body>
</html>